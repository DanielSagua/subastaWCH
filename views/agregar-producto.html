<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agregar Producto</title>
  <link rel="icon" type="image/x-icon" href="images/favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .thumb {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: .5rem;
    }

    .thumb-card {
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
    }

    .thumb-card.active {
      border-color: var(--bs-primary);
      box-shadow: 0 0 0 .2rem rgba(13, 110, 253, .25);
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-dark bg-dark px-3">
    <a class="navbar-brand" href="/gestion-productos.html">Gesti√≥n de Productos</a>
  </nav>

  <div class="container py-5">
    <h2 class="mb-4">Agregar nuevo producto</h2>

    <form id="formAgregar" enctype="multipart/form-data" method="POST" action="/productos">
      <div class="mb-3">
        <label for="nombre" class="form-label">Nombre del producto</label>
        <input type="text" id="nombre" name="nombre" class="form-control" required placeholder="Escribe el nombre del producto." />
      </div>

      <div class="mb-3">
        <label for="descripcion" class="form-label">Descripci√≥n</label>
        <textarea id="descripcion" name="descripcion" class="form-control" required placeholder="Escribe aqui la descripcion del producto."></textarea>
      </div>

      <div class="mb-3">
        <label for="precio" class="form-label">Precio base ($)</label>
        <input type="number" id="precio" name="precio" class="form-control" required min="0" step="1000"
          inputmode="numeric" pattern="\d*" placeholder="M√∫ltiplos de $1.000" />

      </div>

      <!-- Selecci√≥n y previsualizaci√≥n de im√°genes -->
      <div class="mb-2">
        <label class="form-label">Im√°genes del producto</label>
        <input type="file" id="inputImgs" name="imagenes" multiple accept="image/*" class="form-control" />
        <div class="form-text">Selecciona hasta 5 im√°genes. Haz clic en una miniatura para marcarla como destacada.
        </div>
      </div>

      <!-- Hidden que tu backend usa para saber cu√°l es la destacada -->
      <input type="hidden" id="imagen_destacada" name="imagen_destacada" value="">

      <!-- Grid de previews -->
      <div id="previewGrid" class="row g-3 mt-1"></div>

      <div class="mt-4">
        <button type="submit" class="btn btn-success" id="btnAgregar">
          <span id="spinnerAgregar" class="spinner-border spinner-border-sm d-none me-2" role="status"
            aria-hidden="true"></span>
          Agregar
        </button>
        <a href="/gestion-productos.html" class="btn btn-secondary ms-2">Volver</a>
      </div>
    </form>

    <div id="mensaje" class="mt-3 text-success"></div>
  </div>

  <script>
    const inputImgs = document.getElementById('inputImgs');
    const previewGrid = document.getElementById('previewGrid');
    const hiddenDestacada = document.getElementById('imagen_destacada');

    function slotKeyByIndex(i) {
      // 0 -> 'imagen', 1 -> 'imagen1', 2 -> 'imagen2', ...
      return i === 0 ? 'imagen' : ('imagen' + i);
    }

    function clearPreviews() {
      previewGrid.innerHTML = '';
    }

    function renderPreviews(files) {
      clearPreviews();
      const max = Math.min(files.length, 5);
      if (files.length > 5) {
        // Si seleccionan m√°s de 5, solo mostramos/mandamos los primeros 5 (el input a√∫n los tiene todos, pero el backend tomar√° los primeros)
        // Puedes mostrar un aviso si quieres:
        console.warn('Se mostrar√°n solo las primeras 5 im√°genes.');
      }

      // Por defecto, marcamos como destacada la primera (si existe)
      if (max > 0) {
        hiddenDestacada.value = slotKeyByIndex(0);
      } else {
        hiddenDestacada.value = '';
      }

      for (let i = 0; i < max; i++) {
        const file = files[i];
        const col = document.createElement('div');
        col.className = 'col-6 col-md-4 col-lg-3';

        const card = document.createElement('div');
        card.className = 'thumb-card card p-2';
        card.dataset.index = String(i);

        const img = document.createElement('img');
        img.className = 'thumb';
        img.alt = `Imagen ${i + 1}`;
        img.src = URL.createObjectURL(file);

        const body = document.createElement('div');
        body.className = 'card-body p-2 text-center';

        const label = document.createElement('div');
        label.className = 'small';
        label.textContent = (i === 0) ? 'Destacada (por defecto)' : `Imagen ${i + 1}`;

        body.appendChild(label);
        card.appendChild(img);
        card.appendChild(body);
        col.appendChild(card);
        previewGrid.appendChild(col);
      }

      // Activar la clase "active" en la destacada por defecto
      const firstCard = previewGrid.querySelector('.thumb-card');
      if (firstCard) firstCard.classList.add('active');
    }

    // Click para marcar destacada OLD
    function updateThumbLabels() {
      // Re-etiqueta seg√∫n posici√≥n visual
      const cards = previewGrid.querySelectorAll('.thumb-card');
      cards.forEach((c, i) => {
        const label = c.querySelector('.card-body .small');
        if (!label) return;
        label.textContent = (i === 0) ? 'Destacada' : `Imagen ${i + 1}`;
      });
    }

    // ‚úÖ Click para marcar imagen destacada y moverla al inicio visual
    previewGrid.addEventListener('click', (e) => {
      const card = e.target.closest('.thumb-card');
      if (!card) return;

      // √çndice ORIGINAL del archivo (no cambia aunque movamos el DOM)
      const idxOriginal = Number(card.dataset.index);
      if (Number.isNaN(idxOriginal)) return;

      // Actualiza hidden con el slot esperado por el backend
      hiddenDestacada.value = slotKeyByIndex(idxOriginal);

      // Quitar "active" previo
      previewGrid.querySelectorAll('.thumb-card.active').forEach(c => c.classList.remove('active'));

      // Mover visualmente el contenedor de la card al inicio
      // (la card est√° dentro de su columna .col-*, movemos esa columna)
      const col = card.closest('[class*="col-"]') || card.parentElement;
      if (col && col.parentElement === previewGrid) {
        previewGrid.insertBefore(col, previewGrid.firstChild);
      }

      // Marcar la primera (reci√©n movida) como activa
      const firstCard = previewGrid.querySelector('.thumb-card');
      if (firstCard) firstCard.classList.add('active');

      // Actualizar etiquetas (Destacada / Imagen N)
      updateThumbLabels();

      // Debug opcional
      // console.log('üìå Destacada (slot backend):', hiddenDestacada.value);
    });


    inputImgs.addEventListener('change', (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) {
        clearPreviews();
        hiddenDestacada.value = '';
        return;
      }

      // Renderiza previews (primeras 5)
      renderPreviews(files);
    });

    // Env√≠o con bloqueo/spinner como ya ten√≠as
    document.getElementById('formAgregar').addEventListener('submit', async function (e) {
      e.preventDefault();

      const form = document.getElementById('formAgregar');
      const formData = new FormData(form);
      const btn = document.getElementById('btnAgregar');
      const spinner = document.getElementById('spinnerAgregar');
      const mensaje = document.getElementById('mensaje');

      btn.disabled = true;
      spinner.classList.remove('d-none');
      mensaje.textContent = '';
      mensaje.classList.remove('text-danger', 'text-success');

      try {

        // ‚úÖ Validaci√≥n: precio m√∫ltiplo de 1000
        const precioVal = Number(formData.get('precio'));
        if (!Number.isFinite(precioVal) || precioVal <= 0) {
          mensaje.classList.add('text-danger');
          mensaje.textContent = 'Ingresa un precio v√°lido.';
          btn.disabled = false;
          spinner.classList.add('d-none');
          return;
        }
        if (precioVal % 1000 !== 0) {
          mensaje.classList.add('text-danger');
          mensaje.textContent = 'El precio base debe ser un m√∫ltiplo de $1.000.';
          btn.disabled = false;
          spinner.classList.add('d-none');
          return;
        }


        const res = await fetch('/productos', { method: 'POST', body: formData });
        const data = await res.json();

        if (res.ok) {
          mensaje.classList.add('text-success');
          mensaje.textContent = 'Producto agregado exitosamente.';
          form.reset();
          clearPreviews();
          hiddenDestacada.value = '';
        } else {
          mensaje.classList.add('text-danger');
          mensaje.textContent = data.message || 'Error al agregar producto';
        }
      } catch (err) {
        console.error(err);
        mensaje.classList.add('text-danger');
        mensaje.textContent = 'Error al conectar con el servidor';
      } finally {
        btn.disabled = false;
        spinner.classList.add('d-none');
      }
    });
   
    //Ayuda en vivo al escribir
    document.getElementById('precio').addEventListener('input', (e) => {
      const v = Number(e.target.value);
      if (!Number.isFinite(v)) return;
      // Solo feedback visual en el placeholder/validaci√≥n nativa; no forzamos el valor
      e.target.setCustomValidity((v % 1000 === 0 || v === 0) ? '' : 'Debe ser m√∫ltiplo de 1000');
    });

  </script>
</body>

</html>