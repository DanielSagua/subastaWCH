<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SubastasWCH - Inicio</title>
  <link rel="icon" type="image/x-icon" href="images/favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/css/style.css">

</head>

<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-custom">
    <div class="container">
      <a class="navbar-brand" href="home.html">Subastas WCH</a>
      <span id="usuarioActivo" class="navbar-text text-light"></span>

      <div class="ms-auto">
        <a href="/admin.html" id="btnAdmin" class="btn btn-warning d-none me-2">Panel Admin</a>
        <a href="/misOfertas.html" id="btnMisOfertas" class="btn btn-outline-light me-2 d-none">Mis ofertas</a>
        <a href="/logout" class="btn btn-outline-light">Cerrar sesi√≥n</a>
      </div>
    </div>
  </nav>

  <main class="container my-5">
    <!-- <h2 class="mb-4 text-center">Productos disponibles</h2> -->
    <div class="text-center mb-4">
      <h1 class="display-6 fw-bold d-inline-flex align-items-center gap-2">
        <i class="bi-cart-check-fill texto-azul-primario"></i>
        Productos disponibles
        <span id="badgeCount" class="badge  text-bg-primary ms-1 fs-4">0</span>
      </h1>
      <p class="text-secondary mt-2 mb-0">Explora las subastas activas en este momento</p>
    </div>

    <div id="contenedorProductos" class="row g-4">
      <!-- Productos aqu√≠ -->
    </div>
  </main>
  <!-- FOOTER -->
  <footer class="bg-dark text-white text-center py-1 mt-5">
    <div class="container">
      &copy; <span id="anioActual"></span> DanielS 2025 | Subastas Internas WEG Chile | Area Operaciones
    </div>
  </footer>

  <script>
    // Confirmaci√≥n de logout (funciona con URLs absolutas o relativas)
    function esLogoutLink(a) {
      try {
        const u = new URL(a.getAttribute('href'), location.href);
        return u.pathname === '/logout';
      } catch { return false; }
    }

    document.addEventListener('click', (e) => {
      const a = e.target.closest('a');
      if (!a || !esLogoutLink(a)) return;
      e.preventDefault();
      if (confirm('¬øSeguro que deseas cerrar sesi√≥n?')) {
        // respeta href exacto (por si es absoluto)
        location.href = a.href;
      }
    });
  </script>


  <script>

    let _countdownTimer = null;
    const _deadlines = new Map();

    function _formatTTL(ms) {
      if (ms <= 0) return 'Finalizado';
      const totalSec = Math.floor(ms / 1000);
      const d = Math.floor(totalSec / 86400);
      const h = Math.floor((totalSec % 86400) / 3600);
      const m = Math.floor((totalSec % 3600) / 60);
      const s = totalSec % 60;
      const hh = String(h).padStart(2, '0');
      const mm = String(m).padStart(2, '0');
      const ss = String(s).padStart(2, '0');
      return d > 0 ? `${d}d ${hh}:${mm}:${ss}` : `${hh}:${mm}:${ss}`;
    }

    function _tickCountdowns() {
      const now = Date.now();
      for (const [id, deadline] of _deadlines.entries()) {
        const el = document.getElementById(`ttl-${id}`);
        if (!el) continue;
        const rem = deadline - now;
        el.textContent = _formatTTL(rem);
        if (rem <= 0) {
          // opcional: marcar visualmente
          el.classList.remove('text-danger');
          el.classList.add('text-muted');
        }
      }
    }

    function _startCountdownLoop() {
      if (_countdownTimer) clearInterval(_countdownTimer);
      if (_deadlines.size === 0) return;
      _tickCountdowns(); // pinta de inmediato
      _countdownTimer = setInterval(_tickCountdowns, 1000);
    }


    async function cargarProductos() {
      try {
        const res = await fetch('/productos/activos');
        const productos = await res.json();

        // ‚úÖ Actualiza el contador del t√≠tulo
        const badge = document.getElementById('badgeCount');
        if (badge) badge.textContent = productos.length;

        const contenedor = document.getElementById('contenedorProductos');
        contenedor.innerHTML = '';

        // limpiar deadlines previos
        _deadlines.clear();
        if (_countdownTimer) { clearInterval(_countdownTimer); _countdownTimer = null; }


        // ‚úÖ Si no hay productos activos, muestra mensaje
        if (productos.length === 0) {
          contenedor.innerHTML = `
        <div class="col-12">
          <div class="card border-0 shadow-sm text-center p-5">
            <div class="mb-2" style="font-size:2.5rem;">üõéÔ∏è</div>
            <h5 class="mb-2">No hay productos activos por ahora</h5>
            <p class="text-muted mb-0">
              En cuanto subamos un producto te avisaremos por correo.
            </p>
          </div>
        </div>
      `;
          return; // salir de la funci√≥n
        }

        // ‚úÖ Renderiza productos si existen
        productos.forEach(p => {
          const imagen = p[p.imagen_destacada] || 'test.webp';

          const card = document.createElement('div');
          card.className = 'col-md-4';
          card.innerHTML = `
        <div class="card card-altura-fija shadow">
          <div class="card-body">
            <img src="/uploads/${imagen}" class="img-fluid mb-3 img-cuadrada" alt="Producto"
                 style="cursor: pointer;" onclick="location.href='/producto.html?id=${p.id_producto}'" />
            <h5 class="card-title texto-azul-primario">${p.nombre_producto}</h5>
            <p class="card-text descripcion-con-saltos">
              ${(p.descripcion_producto || '')
              .split(' ')
              .slice(0, 30)
              .join(' ') + ((p.descripcion_producto?.split(' ').length > 30) ? '‚Ä¶' : '')}
            </p>
            <p><strong>Precio base:</strong> $${p.precio_producto.toLocaleString()}</p>
            <p><strong>Oferta m√°xima:</strong> ${p.oferta_maxima
              ? `$${p.oferta_maxima.toLocaleString()}`
              : 'Nadie ha ofertado a√∫n'
            }</p>

            <p><strong>Termina en:</strong> <span class="text-danger fw-semibold" id="ttl-${p.id_producto}">--:--:--</span></p>

            <a href="/producto.html?id=${p.id_producto}" class="btn btn-sm btn-outline-primary">Ver m√°s</a>
          </div>
        </div>
      `;

          contenedor.appendChild(card);

          // Registrar deadline (preferimos remaining_seconds del backend)
          let deadlineMs;
          if (typeof p.remaining_seconds === 'number') {
            deadlineMs = Date.now() + Math.max(0, p.remaining_seconds) * 1000;
          } else if (p.fecha_fin) {
            deadlineMs = new Date(p.fecha_fin).getTime();
          } else if (typeof p.duracion_min === 'number' && p.fecha_publicacion_producto) {
            deadlineMs = new Date(p.fecha_publicacion_producto).getTime() + p.duracion_min * 60 * 1000;
          } else {
            // Fallback 48h (no deber√≠a pasar si vienes usando listarActivos mejorado)
            deadlineMs = new Date(p.fecha_publicacion_producto).getTime() + 48 * 60 * 60 * 1000;
          }
          _deadlines.set(p.id_producto, deadlineMs);

          _startCountdownLoop();

        });
      } catch (error) {
        console.error(error);
        document.getElementById('contenedorProductos').innerHTML =
          '<p class="text-danger text-center">Error al cargar productos.</p>';
      }
    }


    cargarProductos();



    // ‚úÖ Cargar datos del usuario activo y mostrar botones seg√∫n rol

    async function cargarUsuarioActivo() {
      try {
        const res = await fetch('/usuario/perfil');
        if (!res.ok) throw new Error();
        const data = await res.json();

        const saludo = document.getElementById('usuarioActivo');
        if (saludo) saludo.textContent = `Bienvenido, ${data.nombre_usuario || data.nombre || ''}`;

        const btnMisOfertas = document.getElementById('btnMisOfertas');
        if (btnMisOfertas) btnMisOfertas.classList.remove('d-none');

        const btnAdmin = document.getElementById('btnAdmin');
        if (btnAdmin) {
          // acepta 'admin' o 'Administrador' por si tu BD usa texto distinto
          if (String(data.tipo_usuario).toLowerCase() === 'admin' || String(data.tipo_usuario).toLowerCase() === 'administrador') {
            btnAdmin.classList.remove('d-none');
          } else {
            btnAdmin.classList.add('d-none');
          }
        }
      } catch {
        const saludo = document.getElementById('usuarioActivo');
        if (saludo) saludo.textContent = '';
        const btnMisOfertas = document.getElementById('btnMisOfertas');
        const btnAdmin = document.getElementById('btnAdmin');
        if (btnMisOfertas) btnMisOfertas.classList.add('d-none');
        if (btnAdmin) btnAdmin.classList.add('d-none');
      }
    }
    cargarUsuarioActivo();


    mostrarBotonAdmin();



  </script>
</body>

</html>