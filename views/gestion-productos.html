<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GestiÃ³n de ArtÃ­culos</title>
  <link rel="icon" type="image/x-icon" href="images/favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-3">
    <a class="navbar-brand" href="/admin.html">Panel Admin</a>
    <div class="ms-auto">
      <a href="/logout" class="btn btn-outline-light">Cerrar sesiÃ³n</a>
    </div>
  </nav>

  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div class="d-flex align-items-center gap-2">
        <h2 class="mb-0">GestiÃ³n de productos</h2>
      </div>
      <div class="d-flex gap-2">
        <a href="/agregar-producto.html" class="btn btn-success">Agregar producto</a>
        <a href="/admin.html" class="btn btn-primary">Volver</a>
      </div>

    </div>

    <div class="row align-items-center mb-3">
      <div class="col-md-6">
        <input id="buscador" type="text" class="form-control" placeholder="Buscar por producto o usuarioâ€¦">
      </div>
      <div class="col-md-6 text-end">
        <small class="text-muted">Resultados: <span id="countResultados">0</span></small>
      </div>
    </div>


    <table class="table table-bordered table-hover shadow-sm">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Precio</th>
          <th>Oferta mÃ¡xima</th>
          <th>Publicado</th>
          <th>Estado</th>
          <th>Ganador</th>
          <th>Acciones</th>
        </tr>

      </thead>
      <tbody id="tablaArticulos">
        <!-- Filas dinÃ¡micas -->
      </tbody>
    </table>
    <div class="d-flex justify-content-center mt-3" id="paginacionProductos"></div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Modal Historial de Ofertas -->
  <div class="modal fade" id="modalOfertas" tabindex="-1" aria-labelledby="modalOfertasLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header" style="background-color:#005387;">
          <h5 class="modal-title text-white" id="modalOfertasLabel">Historial de ofertas</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2 text-muted" id="infoProductoModal"></div>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>Usuario</th>
                  <th class="text-end">Monto</th>
                  <th>Fecha</th>
                </tr>
              </thead>
              <tbody id="tbodyOfertas">
                <tr>
                  <td colspan="3" class="text-muted">Selecciona un productoâ€¦</td>
                </tr>
              </tbody>
            </table>
            <div class="d-flex justify-content-center mt-3" id="paginacionOfertas"></div>


          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    //     async function cargarArticulos() {
    //       try {
    //         const res = await fetch('/productos');
    //         const productos = await res.json();
    //         const tabla = document.getElementById('tablaArticulos');
    //         tabla.innerHTML = '';

    //         productos.forEach(p => {
    //           const fila = document.createElement('tr');
    //           const finalizada = p.finalizada ? 'Finalizada' : 'Activa';
    //           const ganador = p.nombre_ganador || '-';

    //           fila.innerHTML = `
    //   <td>${p.id_producto}</td>
    //   <td>${p.nombre_producto}</td>
    //   <td>$${p.precio_producto.toLocaleString()}</td>
    //   <td>$${(p.oferta_maxima || 0).toLocaleString()}</td>
    //   <td>${new Date(p.fecha_publicacion_producto).toLocaleDateString()}</td>
    //   <td>${finalizada}</td>
    //   <td>${ganador}</td>
    //   <td>
    //     <a href="/editar-producto.html?id=${p.id_producto}" class="btn btn-sm btn-warning mb-1">Editar</a>
    //   <button 
    //     class="btn btn-sm btn-primary ver-ofertas mb-1" 
    //     data-id="${p.id_producto}" 
    //     data-nombre="${p.nombre_producto}">
    //     Ver ofertas
    //   </button>

    //     <button onclick="eliminarProducto(${p.id_producto})" class="btn btn-sm btn-danger mb-1">Eliminar</button>
    //     ${!p.finalizada ? `<button onclick="finalizarProducto(${p.id_producto})" class="btn btn-sm btn-outline-primary">Finalizar</button>` : ''}
    //   </td>
    // `;



    //           tabla.appendChild(fila);
    //         });
    //       } catch (err) {
    //         console.error(err);
    //       }
    //     }
    // ====== NUEVA FUNCIÃ“N DE GESTIÃ“N DE PRODUCTOS ======
    let productosCacheOriginal = []; // copia completa para filtrar
    let productosCache = [];
    let currentPage = 1;
    const pageSize = 20;

    // Debounce simple
    function debounce(fn, wait = 200) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), wait);
      };
    }

    // Normalizar texto para comparar
    function norm(s) {
      return (s || '').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    // Aplica filtro sobre productosCacheOriginal y vuelve a ordenar + paginar
    function aplicarFiltro(q) {
      const qn = norm(q);
      if (!qn) {
        productosCache = ordenarDescPorFecha(productosCacheOriginal);
      } else {
        productosCache = ordenarDescPorFecha(
          productosCacheOriginal.filter(p => {
            const np = norm(p.nombre_producto);
            const ng = norm(p.nombre_ganador || ''); // ganador puede venir null
            return np.includes(qn) || ng.includes(qn);
          })
        );
      }
      document.getElementById('countResultados').textContent = productosCache.length;
      renderTablaProductos(1);
    }

    // Listener del buscador
    const inputBuscar = document.getElementById('buscador');
    if (inputBuscar) {
      inputBuscar.addEventListener('input', debounce(e => {
        aplicarFiltro(e.target.value);
      }, 200));
    }


    // ðŸ”½ Orden descendente por fecha de publicaciÃ³n
    function ordenarDescPorFecha(arr) {
      return arr.slice().sort((a, b) => {
        const fa = a.fecha_publicacion_producto ? new Date(a.fecha_publicacion_producto).getTime() : 0;
        const fb = b.fecha_publicacion_producto ? new Date(b.fecha_publicacion_producto).getTime() : 0;
        if (fb !== fa) return fb - fa; // mÃ¡s recientes primero
        return Number(b.id_producto || 0) - Number(a.id_producto || 0);
      });
    }

    // ðŸ”½ Renderiza tabla paginada
    function renderTablaProductos(page = 1) {
      const tabla = document.getElementById('tablaArticulos');
      tabla.innerHTML = '';

      const total = productosCache.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      currentPage = Math.min(Math.max(1, page), totalPages);

      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const slice = productosCache.slice(start, end);

      if (slice.length === 0) {
        tabla.innerHTML = `<tr><td colspan="8" class="text-center text-muted">No hay productos</td></tr>`;
        document.getElementById('paginacionProductos').innerHTML = '';
        return;
      }

      slice.forEach(p => {
        const finalizada = p.finalizada ? 'Finalizada' : 'Activa';
        const ganador = p.nombre_ganador || '-';
        const fila = document.createElement('tr');
        fila.innerHTML = `
      <td>${p.id_producto}</td>
      <td>${p.nombre_producto}</td>
      <td>$${Number(p.precio_producto).toLocaleString()}</td>
      <td>$${(p.oferta_maxima || 0).toLocaleString()}</td>
      <td>${new Date(p.fecha_publicacion_producto).toLocaleDateString()}</td>
      <td>${finalizada}</td>
      <td>${ganador}</td>
      <td>
        <a href="/editar-producto.html?id=${p.id_producto}" class="btn btn-sm btn-warning mb-1">Editar</a>
        <button class="btn btn-sm btn-primary ver-ofertas mb-1" data-id="${p.id_producto}" data-nombre="${p.nombre_producto}">Ver ofertas</button>
        <button onclick="eliminarProducto(${p.id_producto})" class="btn btn-sm btn-danger mb-1">Eliminar</button>
        ${!p.finalizada ? `<button onclick="finalizarProducto(${p.id_producto})" class="btn btn-sm btn-outline-primary">Finalizar</button>` : ''}
      </td>
    `;
        tabla.appendChild(fila);
      });

      renderPaginacionProductos(totalPages);
    }

    // ðŸ”½ Botones de paginaciÃ³n
    function renderPaginacionProductos(totalPages) {
      const cont = document.getElementById('paginacionProductos');
      cont.innerHTML = '';

      if (totalPages <= 1) return;

      const mkBtn = (label, page, active = false, disabled = false) => {
        const b = document.createElement('button');
        b.textContent = label;
        b.className = `btn btn-sm ${active ? 'btn-primary' : 'btn-outline-primary'} me-1`;
        b.disabled = disabled;
        b.addEventListener('click', () => renderTablaProductos(page));
        return b;
      };

      // BotÃ³n Â« Anterior
      cont.appendChild(mkBtn('Â«', currentPage - 1, false, currentPage === 1));

      const maxBtns = 8;
      let start = Math.max(1, currentPage - Math.floor(maxBtns / 2));
      let end = Math.min(totalPages, start + maxBtns - 1);
      if (end - start + 1 < maxBtns) start = Math.max(1, end - maxBtns + 1);

      for (let i = start; i <= end; i++) {
        cont.appendChild(mkBtn(String(i), i, i === currentPage));
      }

      // BotÃ³n Siguiente Â»
      cont.appendChild(mkBtn('Â»', currentPage + 1, false, currentPage === totalPages));
    }

    // ðŸ”½ Cargar desde backend y aplicar orden + paginaciÃ³n
    async function cargarArticulos() {
      try {
        const res = await fetch('/productos');
        const productos = await res.json();

        productosCacheOriginal = productos.slice(); // guardamos todo
        productosCache = ordenarDescPorFecha(productosCacheOriginal);
        document.getElementById('countResultados').textContent = productosCache.length;
        renderTablaProductos(1);
      } catch (err) {
        console.error(err);
        const tabla = document.getElementById('tablaArticulos');
        tabla.innerHTML = `<tr><td colspan="8" class="text-center text-danger">Error al cargar productos</td></tr>`;
      }
    }



    async function eliminarArticulo(id) {
      if (confirm('Â¿EstÃ¡s seguro de eliminar este artÃ­culo?')) {
        try {
          const res = await fetch(`/productos/${id}`, { method: 'DELETE' });
          const data = await res.json();
          if (res.ok) {
            alert(data.message);
            cargarArticulos();
          } else {
            alert('Error: ' + data.message);
          }
        } catch (e) {
          alert('Error al eliminar');
        }
      }
    }

    async function finalizarProducto(id) {
      if (!confirm('Â¿EstÃ¡s seguro de finalizar esta subasta? Esta acciÃ³n no se puede deshacer.')) return;

      try {
        const res = await fetch(`/productos/${id}/finalizar`, { method: 'POST' });
        const data = await res.json();

        if (res.ok) {
          alert(data.message);
          cargarArticulos();
        } else {
          alert('Error: ' + data.message);
        }
      } catch (err) {
        alert('Error al intentar finalizar la subasta.');
        console.error(err);
      }
    }

    async function eliminarProducto(id) {
      if (!confirm('Â¿EstÃ¡s seguro de que quieres eliminar este producto?')) return;

      try {
        const res = await fetch(`/productos/${id}`, { method: 'DELETE' });
        const data = await res.json();

        if (res.ok) {
          alert('Producto eliminado correctamente');
          location.reload();
        } else {
          alert(data.message || 'Error al eliminar el producto');
        }
      } catch (err) {
        console.error(err);
        alert('Error de conexiÃ³n con el servidor');
      }
    }

    // ðŸ”„ FunciÃ³n que carga ofertas con paginaciÃ³n
    async function cargarOfertas(id, page = 1) {
      const tbody = document.getElementById('tbodyOfertas');
      const pag = document.getElementById('paginacionOfertas');

      try {
        const res = await fetch(`/producto/${id}/ofertas?page=${page}`);
        const result = await res.json();
        const ofertas = result.data || [];
        const totalPages = result.totalPages || 1;

        tbody.innerHTML = '';

        if (!ofertas.length) {
          tbody.innerHTML = `<tr><td colspan="3" class="text-muted text-center">Sin ofertas aÃºn</td></tr>`;
          pag.innerHTML = '';
          return;
        }

        // ðŸ•“ Mostrar de mÃ¡s reciente a mÃ¡s antigua
        for (const o of ofertas) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
        <td>${o.nombre_usuario}</td>
        <td class="text-end">$${Number(o.monto_oferta).toLocaleString('es-CL')}</td>
        <td>${new Date(o.fecha_oferta).toLocaleString('es-CL')}</td>
      `;
          tbody.appendChild(tr);
        }

        // ðŸ”¢ PaginaciÃ³n inferior
        pag.innerHTML = '';
        for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement('button');
          btn.textContent = i;
          btn.className = `btn btn-sm ${i === page ? 'btn-primary' : 'btn-outline-primary'} me-1`;
          btn.addEventListener('click', () => cargarOfertas(id, i));
          pag.appendChild(btn);
        }
      } catch (err) {
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="3" class="text-danger text-center">Error al cargar ofertas</td></tr>`;
        pag.innerHTML = '';
      }
    }

    // ðŸŽ¯ Evento: abrir el modal y cargar la primera pÃ¡gina
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('.ver-ofertas');
      if (!btn) return;

      const id = btn.getAttribute('data-id');
      const nombre = btn.getAttribute('data-nombre');

      // Actualizar tÃ­tulo e info
      document.getElementById('modalOfertasLabel').textContent = `Historial de ofertas`;
      document.getElementById('infoProductoModal').textContent = `Producto: ${nombre} (ID ${id})`;

      const tbody = document.getElementById('tbodyOfertas');
      tbody.innerHTML = `<tr><td colspan="3" class="text-muted">Cargandoâ€¦</td></tr>`;

      // Mostrar modal
      const modal = new bootstrap.Modal(document.getElementById('modalOfertas'));
      modal.show();

      // Cargar pÃ¡gina 1 (mÃ¡s recientes primero)
      await cargarOfertas(id, 1);
    });


    cargarArticulos();
  </script>

</body>

</html>